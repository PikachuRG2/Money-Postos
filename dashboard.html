
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Money Postos</title>
    <link rel="stylesheet" href="style.css">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f1c40f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <header style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="icon-192x192.png" alt="Logo" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
                <h1 style="font-size: 1.3rem; margin: 0; color: var(--primary-color);">Posto Paraíso</h1>
            </div>
            <button onclick="logout()" class="btn-logout">Sair</button>
        </header>

        <main class="dashboard-card">
            <div class="user-info">
                <p>Bem-vindo, <span id="user-name">Carregando...</span></p>
                <div class="balance-container">
                    <h3>Seu Saldo</h3>
                    <p class="balance">R$ <span id="user-balance">0,00</span></p>
                </div>
            </div>

            <div class="actions">
                <p>Apresente seu QR Code no posto para ganhar cashback!</p>
                <!-- Simulação de QR Code -->
                <div id="qrcode-container">
                    <div id="qrcode-placeholder">
                        [ GERANDO QR... ]
                    </div>
                    <p id="transaction-id-display"></p>
                </div>
                
                <div class="action-buttons" style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="gerarNovoToken('ganho')" class="btn-secondary" style="width: auto; padding: 10px 20px;">⚡ Ganhar Cashback</button>
                    
                    <div class="resgate-container" style="display: flex; flex-direction: column; align-items: center; background: #333; padding: 15px; border-radius: 10px; border: 1px solid #444; width: 100%; margin-top: 10px;">
                        <label style="font-size: 0.8rem; margin-bottom: 5px; color: var(--primary-color);">Valor para utilizar:</label>
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <input type="number" id="valor-resgate" placeholder="R$ 0,00" step="0.01" min="0.01" style="margin-bottom: 0; flex: 1;">
                            <button onclick="gerarNovoToken('resgate')" class="btn-primary" style="width: auto; padding: 10px 15px; background: #e67e22; color: white;">Utilizar Saldo</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="history-container">
                <h3>Últimas Transações</h3>
                <div id="transaction-list">
                    <p>Nenhuma transação encontrada.</p>
                </div>
            </div>
        </main>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Verificar se o usuário é admin e redirecionar se necessário
                db.collection("usuarios").doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().role === 'admin') {
                        window.location.href = "admin.html";
                        return;
                    }
                });

                // Buscar dados do usuário em tempo real
                db.collection("usuarios").doc(user.uid).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('user-name').innerText = data.nome;
                        document.getElementById('user-balance').innerText = data.saldo.toFixed(2).replace('.', ',');
                    }
                });

                // Gerar token de transação inicial (ganho por padrão)
                gerarNovoToken('ganho');

                // Buscar histórico de transações em tempo real
                db.collection("transacoes")
                    .where("userId", "==", user.uid)
                    .orderBy("dataCriacao", "desc")
                    .limit(5)
                    .onSnapshot((snapshot) => {
                        const list = document.getElementById('transaction-list');
                        if (snapshot.empty) {
                            list.innerHTML = "<p>Nenhuma transação encontrada.</p>";
                            return;
                        }
                        
                        list.innerHTML = "";
                        snapshot.forEach((doc) => {
                            const t = doc.data();
                            if (t.status !== 'concluido') return; // Só mostrar concluídas no histórico simplificado

                            const data = t.dataFinalizacao ? t.dataFinalizacao.toDate().toLocaleDateString('pt-BR') : 'Recent...';
                            const valorStr = t.valor ? t.valor.toFixed(2).replace('.', ',') : '0,00';
                            const sinal = t.tipo === 'resgate' ? '-' : '+';
                            const cor = t.tipo === 'resgate' ? 'color: var(--error-color);' : 'color: var(--success-color);';

                            const div = document.createElement('div');
                            div.className = 'transaction-item';
                            div.innerHTML = `
                                <span>${data} (${t.tipo || 'ganho'})</span>
                                <span class="trans-val" style="${cor}">${sinal} R$ ${valorStr}</span>
                            `;
                            list.appendChild(div);
                        });
                    });
            } else {
                window.location.href = "index.html";
            }
        });

        function logout() {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        }

        let currentTransactionId = null;
        let unsubscribeTransaction = null;
        let qrcode = null;

        function generate8DigitToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let token = '';
            for (let i = 0; i < 8; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        }

        function gerarNovoToken(tipo = 'ganho') {
            const user = auth.currentUser;
            if (!user) return;

            let valor = 0.50; // Valor padrão para ganho
            
            if (tipo === 'resgate') {
                const valorInput = document.getElementById('valor-resgate').value;
                valor = parseFloat(valorInput);
                
                if (isNaN(valor) || valor <= 0) {
                    alert("Informe um valor válido para utilizar!");
                    return;
                }

                // Verificar saldo antes de gerar o token
                const saldoAtual = parseFloat(document.getElementById('user-balance').innerText.replace(',', '.'));
                if (valor > saldoAtual) {
                    alert("Saldo insuficiente para este valor!");
                    return;
                }
            }

            // Limpar monitoramento anterior se houver
            if (unsubscribeTransaction) unsubscribeTransaction();
            
            const qrPlaceholder = document.getElementById('qrcode-placeholder');
            qrPlaceholder.innerHTML = "Gerando...";
            document.getElementById('transaction-id-display').innerText = "";

            const token = generate8DigitToken();

            // Criar uma nova transação pendente com ID personalizado de 8 dígitos
            db.collection("transacoes").doc(token).set({
                userId: user.uid,
                status: 'pendente',
                usado: false,
                tipo: tipo,
                valor: valor,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                currentTransactionId = token;
                
                // Gerar QR Code Real
                qrPlaceholder.innerHTML = "";
                if (qrcode) {
                    qrcode.clear();
                    qrcode.makeCode(currentTransactionId);
                } else {
                    qrcode = new QRCode(qrPlaceholder, {
                        text: currentTransactionId,
                        width: 180,
                        height: 180,
                        colorDark : tipo === 'resgate' ? "#e67e22" : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
                
                document.getElementById('transaction-id-display').innerText = `TOKEN (${tipo.toUpperCase()}): ${currentTransactionId}`;
                if (tipo === 'resgate') {
                    document.getElementById('transaction-id-display').innerText += ` | VALOR: R$ ${valor.toFixed(2)}`;
                }

                // Monitorar se a transação foi processada pelo admin
                unsubscribeTransaction = db.collection("transacoes").doc(currentTransactionId)
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data().status === 'concluido') {
                            alert(tipo === 'resgate' ? "Saldo utilizado com sucesso!" : "Cashback recebido com sucesso!");
                            if (tipo === 'resgate') document.getElementById('valor-resgate').value = "";
                            gerarNovoToken('ganho'); // Volta para o padrão
                        }
                    });
            }).catch(err => {
                console.error("Erro ao gerar token:", err);
                qrPlaceholder.innerText = "Erro ao gerar QR";
            });
        }

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then((registration) => {
                    console.log('SW registrado com sucesso!', registration.scope);
                }).catch((err) => {
                    console.log('Erro ao registrar SW:', err);
                });
            });
        }
    </script>
</body>
</html>
