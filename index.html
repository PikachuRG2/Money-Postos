
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Postos - Login</title>
    <link rel="stylesheet" href="style.css">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f1c40f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <img src="icon-192x192.png" alt="Logo Posto Para칤so" style="width: 120px; border-radius: 20px; margin-bottom: 15px;">
            <h1>Posto Para칤so</h1>
            <p>Seu cashback em cada abastecimento</p>
        </header>

        <main class="auth-card">
            <div id="login-form">
                <h2>Entrar</h2>
                <input type="email" id="login-email" placeholder="E-mail">
                <input type="password" id="login-password" placeholder="Senha">
                <button onclick="login()">Entrar</button>
                <p><a href="#" onclick="forgotPassword()" style="font-size: 0.85rem; color: #aaa;">Esqueci minha senha</a></p>
                <p>N칚o tem conta? <a href="#" onclick="toggleAuth()">Cadastre-se</a></p>
            </div>

            <div id="signup-form" style="display: none;">
                <h2>Cadastro</h2>
                <input type="text" id="signup-name" placeholder="Nome Completo">
                <input type="text" id="signup-cpf" placeholder="CPF (apenas n칰meros)" maxlength="11">
                <input type="tel" id="signup-phone" placeholder="Telefone (DDD + n칰mero)" maxlength="11">
                <input type="email" id="signup-email" placeholder="E-mail">
                <input type="password" id="signup-password" placeholder="Senha">
                <button onclick="signup()">Cadastrar</button>
                <p>J치 tem conta? <a href="#" onclick="toggleAuth()">Fa칞a login</a></p>
            </div>

            <div id="install-container" style="display: none; margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                <button id="btn-install" class="btn-install">游 Instalar Aplicativo</button>
            </div>
        </main>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        function toggleAuth() {
            const login = document.getElementById('login-form');
            const signup = document.getElementById('signup-form');
            if (login.style.display === 'none') {
                login.style.display = 'block';
                signup.style.display = 'none';
            } else {
                login.style.display = 'none';
                signup.style.display = 'block';
            }
        }

        function login() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Buscar a role do usu치rio para saber para onde redirecionar
                    return db.collection("usuarios").doc(user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists && doc.data().role === 'admin') {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "dashboard.html";
                    }
                })
                .catch((error) => {
                    alert("Erro ao entrar: " + error.message);
                });
        }

        function forgotPassword() {
            const email = document.getElementById('login-email').value;
            if (!email) {
                alert("Por favor, digite seu e-mail no campo acima para redefinir a senha.");
                return;
            }

            if (confirm(`Deseja enviar um e-mail de redefini칞칚o de senha para ${email}?`)) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert("E-mail de redefini칞칚o enviado! Verifique sua caixa de entrada (e o spam).");
                    })
                    .catch((error) => {
                        alert("Erro ao enviar e-mail: " + error.message);
                    });
            }
        }

        function signup() {
            const name = document.getElementById('signup-name').value;
            const cpf = document.getElementById('signup-cpf').value;
            const phone = document.getElementById('signup-phone').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-password').value;

            if (cpf.length !== 11) {
                alert("Por favor, insira um CPF v치lido com 11 d칤gitos.");
                return;
            }

            if (phone.length < 10) {
                alert("Por favor, insira um telefone v치lido (DDD + n칰mero).");
                return;
            }

            // Desabilitar o bot칚o para evitar m칰ltiplos cliques
            const btn = document.querySelector('#signup-form button');
            btn.disabled = true;
            btn.innerText = "Cadastrando...";

            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Salvar dados extras no Firestore
                    return db.collection("usuarios").doc(user.uid).set({
                        nome: name,
                        cpf: cpf,
                        telefone: phone,
                        email: email,
                        saldo: 0,
                        role: 'cliente',
                        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // Ap칩s salvar os dados, redirecionar
                    window.location.href = "dashboard.html";
                })
                .catch((error) => {
                    alert("Erro ao cadastrar: " + error.message);
                    btn.disabled = false;
                    btn.innerText = "Cadastrar";
                });
        }

        // Verificar se j치 est치 logado e redirecionar apenas se n칚o estivermos no meio de um cadastro
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Pequeno delay para garantir que o Firestore tenha tempo de processar o documento rec칠m-criado
                db.collection("usuarios").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        if (doc.data().role === 'admin') {
                            window.location.href = "admin.html";
                        } else {
                            window.location.href = "dashboard.html";
                        }
                    }
                });
            }
        });

        // Registrar Service Worker para PWA
        let deferredPrompt;
        const installContainer = document.getElementById('install-container');
        const btnInstall = document.getElementById('btn-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir o Chrome 67 e vers칫es anteriores de mostrar automaticamente o prompt
            e.preventDefault();
            // Guardar o evento para que possa ser acionado mais tarde.
            deferredPrompt = e;
            // Atualizar a interface do usu치rio para notificar o usu치rio que ele pode instalar o PWA
            installContainer.style.display = 'block';
        });

        btnInstall.addEventListener('click', (e) => {
            // Esconder a interface do usu치rio que notifica o usu치rio que ele pode instalar o PWA
            installContainer.style.display = 'none';
            // Mostrar o prompt
            deferredPrompt.prompt();
            // Aguardar a resposta do usu치rio ao prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usu치rio aceitou a instala칞칚o do PWA');
                } else {
                    console.log('Usu치rio recusou a instala칞칚o do PWA');
                }
                deferredPrompt = null;
            });
        });

        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA instalado com sucesso!');
            installContainer.style.display = 'none';
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then((registration) => {
                    console.log('SW registrado com sucesso!', registration.scope);
                }).catch((err) => {
                    console.log('Erro ao registrar SW:', err);
                });
            });
        }
    </script>
</body>
</html>
