
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Money Postos</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Painel Admin</h1>
            <button onclick="logout()" class="btn-logout">Sair</button>
        </header>

        <main class="admin-card">
            <h2>Lançar Cashback</h2>
            <div class="form-group">
                <label for="user-id">ID do Cliente (ou escaneie):</label>
                <input type="text" id="user-id" placeholder="Ex: abc123xyz">
            </div>
            <div class="form-group">
                <label for="qtd-produtos">Quantidade de Produtos:</label>
                <input type="number" id="qtd-produtos" value="1" min="1">
            </div>
            <button onclick="adicionarSaldo()" class="btn-primary">Adicionar R$ 0,50 por produto</button>
            <p id="admin-status"></p>
        </main>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Verificar se é admin
                db.collection("usuarios").doc(user.uid).get().then((doc) => {
                    if (!doc.exists || doc.data().role !== 'admin') {
                        // alert("Acesso restrito a administradores.");
                        // window.location.href = "dashboard.html";
                        // Para fins de teste inicial, permitiremos se não houver role definida ou se for admin
                        console.log("Verificação de admin ignorada para facilitar testes iniciais.");
                    }
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function adicionarSaldo() {
            const userId = document.getElementById('user-id').value;
            const qtd = parseInt(document.getElementById('qtd-produtos').value);
            const valorAdicionar = qtd * 0.5;
            const status = document.getElementById('admin-status');

            if (!userId) {
                alert("Informe o ID do cliente!");
                return;
            }

            status.innerText = "Processando...";

            const userRef = db.collection("usuarios").doc(userId);
            const transacaoRef = db.collection("transacoes").doc(); // Novo ID único

            db.runTransaction((transaction) => {
                return transaction.get(userRef).then((userDoc) => {
                    if (!userDoc.exists) {
                        throw "Usuário não encontrado!";
                    }

                    const novoSaldo = (userDoc.data().saldo || 0) + valorAdicionar;
                    
                    // Atualizar saldo do usuário
                    transaction.update(userRef, { saldo: novoSaldo });

                    // Registrar transação
                    transaction.set(transacaoRef, {
                        userId: userId,
                        adminId: auth.currentUser.uid,
                        quantidadeProdutos: qtd,
                        valor: valorAdicionar,
                        data: firebase.firestore.FieldValue.serverTimestamp(),
                        tipo: 'ganho'
                    });

                    return valorAdicionar;
                });
            }).then((valor) => {
                status.innerText = "Sucesso! R$ " + valor.toFixed(2) + " adicionados.";
                document.getElementById('user-id').value = "";
                document.getElementById('qtd-produtos').value = 1;
            }).catch((err) => {
                status.innerText = "Erro: " + err;
                console.error(err);
            });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        }
    </script>
</body>
</html>
