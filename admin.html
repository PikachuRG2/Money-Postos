
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Money Postos</title>
    <link rel="stylesheet" href="style.css">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f1c40f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
    <div class="container admin-container">
        <header style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="icon-192x192.png" alt="Logo" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
                <h1 style="font-size: 1.3rem; margin: 0; color: var(--primary-color);">Posto Para√≠so</h1>
            </div>
            <button onclick="logout()" class="btn-logout">Sair</button>
        </header>

        <nav class="admin-nav">
            <button onclick="showSection('dashboard')" id="nav-dashboard" class="active">üìä Dashboard</button>
            <button onclick="showSection('lancar')" id="nav-lancar">‚ö° Dar Cashback</button>
            <button onclick="showSection('resgate')" id="nav-resgate" style="background: #e67e22; color: white;">üí∞ Resgatar Saldo</button>
            <button onclick="showSection('produtos')" id="nav-produtos">üì¶ Produtos</button>
            <button onclick="showSection('usuarios')" id="nav-usuarios">üë• Usu√°rios</button>
            <button onclick="showSection('historico')" id="nav-historico">üìú Hist√≥rico</button>
        </nav>

        <!-- Se√ß√£o: Dashboard -->
        <section id="section-dashboard" class="admin-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Saldo Distribu√≠do</h4>
                    <p id="stat-total-distribuido" style="color: var(--success-color);">R$ 0,00</p>
                </div>
                <div class="stat-card">
                    <h4>Total Resgatado</h4>
                    <p id="stat-total-resgatado" style="color: #e67e22;">R$ 0,00</p>
                </div>
                <div class="stat-card">
                    <h4>Saldo em Aberto</h4>
                    <p id="stat-total-aberto" style="color: var(--primary-color);">R$ 0,00</p>
                </div>
                <div class="stat-card">
                    <h4>Clientes</h4>
                    <p id="stat-total-clientes">0</p>
                </div>
            </div>
            <h3>Atividade Recente</h3>
            <div id="recent-activity">
                <!-- Preenchido via JS -->
                <p>Carregando atividade...</p>
            </div>
        </section>

        <!-- Se√ß√£o: Lan√ßar -->
        <section id="section-lancar" class="admin-section">
            <main class="admin-card">
                <h2>‚ö° Dar Cashback ao Cliente</h2>
                
                <div id="reader-container-lancar" class="scanner-container" style="margin-bottom: 20px; display: none;">
                    <div id="reader-lancar" style="width: 100%; border-radius: 10px; overflow: hidden;"></div>
                    <button onclick="stopScanner('lancar')" class="btn-logout" style="margin-top: 10px;">Fechar C√¢mera</button>
                </div>

                <button id="start-scan-btn-lancar" onclick="startScanner('lancar')" class="btn-primary" style="margin-bottom: 20px; background: #2980b9; color: white;">üì∑ Escanear QR do Cliente</button>

                <div class="form-group">
                    <label for="transaction-token-lancar">C√≥digo da Transa√ß√£o (8 d√≠gitos):</label>
                    <input type="text" id="transaction-token-lancar" placeholder="Digite o c√≥digo ou escaneie o QR" maxlength="8" style="text-transform: uppercase; font-family: monospace; font-size: 1.2rem; text-align: center; letter-spacing: 2px;">
                </div>

                <div class="form-group" id="qtd-group">
                    <label for="qtd-produtos">Quantidade (Global):</label>
                    <input type="number" id="qtd-produtos" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>Selecione os Produtos:</label>
                    <div id="products-selection-list" class="products-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <!-- Preenchido via JS -->
                        <p>Carregando produtos...</p>
                    </div>
                </div>

                <div id="valor-calculado-display" style="margin-bottom: 15px; font-weight: bold; color: var(--primary-color);">
                    Valor Total: R$ 0,00
                </div>
                <button onclick="processarTransacao('lancar')" class="btn-primary">Confirmar e Adicionar Cashback</button>
                <p id="admin-status-lancar"></p>
            </main>
        </section>

        <!-- Se√ß√£o: Resgate -->
        <section id="section-resgate" class="admin-section">
            <main class="admin-card" style="border: 2px solid #e67e22;">
                <h2 style="color: #e67e22;">üí∞ Resgatar Saldo do Cliente</h2>
                <p style="font-size: 0.9rem; margin-bottom: 20px; color: #bbb;">Use esta se√ß√£o quando o cliente quiser pagar o abastecimento com o saldo dele.</p>
                
                <div id="reader-container-resgate" class="scanner-container" style="margin-bottom: 20px; display: none;">
                    <div id="reader-resgate" style="width: 100%; border-radius: 10px; overflow: hidden;"></div>
                    <button onclick="stopScanner('resgate')" class="btn-logout" style="margin-top: 10px;">Fechar C√¢mera</button>
                </div>

                <button id="start-scan-btn-resgate" onclick="startScanner('resgate')" class="btn-primary" style="margin-bottom: 20px; background: #e67e22; color: white;">üì∑ Escanear QR de Resgate</button>

                <div class="form-group">
                    <label for="transaction-token-resgate">C√≥digo de Resgate (8 d√≠gitos):</label>
                    <input type="text" id="transaction-token-resgate" placeholder="Digite o c√≥digo ou escaneie o QR" maxlength="8" style="text-transform: uppercase; font-family: monospace; font-size: 1.2rem; text-align: center; letter-spacing: 2px; border-color: #e67e22;">
                </div>

                <button onclick="processarTransacao('resgate')" class="btn-primary" style="background: #e67e22; color: white;">Confirmar Uso de Saldo</button>
                <p id="admin-status-resgate"></p>
            </main>
        </section>

        <!-- Se√ß√£o: Produtos -->
        <section id="section-produtos" class="admin-section">
            <h2>Gerenciar Grade de Produtos</h2>
            <div class="admin-card" style="margin-bottom: 20px;">
                <h3>Novo Produto</h3>
                <div class="form-group">
                    <input type="text" id="new-product-name" placeholder="Nome do Produto (Ex: Gasolina Aditivada)">
                </div>
                <div class="form-group">
                    <input type="number" id="new-product-cashback" placeholder="Cashback por Unidade (Ex: 0.50)" step="0.01">
                </div>
                <button onclick="adicionarProduto()" class="btn-primary">Adicionar Produto</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Cashback/Un</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Se√ß√£o: Usu√°rios -->
        <section id="section-usuarios" class="admin-section">
            <h2>Gerenciar Usu√°rios</h2>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Saldo</th>
                            <th>Role</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Se√ß√£o: Hist√≥rico -->
        <section id="section-historico" class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Hist√≥rico de Transa√ß√µes</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="filtrarHistorico('hoje')" class="btn-secondary" style="width: auto; font-size: 0.8rem; padding: 5px 15px;">Hoje</button>
                    <button onclick="filtrarHistorico('mes')" class="btn-secondary" style="width: auto; font-size: 0.8rem; padding: 5px 15px;">M√™s</button>
                    <button onclick="filtrarHistorico('tudo')" class="btn-secondary" style="width: auto; font-size: 0.8rem; padding: 5px 15px;">Tudo</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Produtos</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Verificar se √© admin
                db.collection("usuarios").doc(user.uid).get().then((doc) => {
                    if (!doc.exists || doc.data().role !== 'admin') {
                        alert("Acesso restrito a administradores.");
                        window.location.href = "dashboard.html";
                    } else {
                        // Iniciar carregamento de dados do painel
                        loadDashboardStats();
                        loadUsersList();
                        loadHistoryList();
                        loadProductsList();
                    }
                }).catch((error) => {
                    console.error("Erro ao verificar admin:", error);
                    window.location.href = "index.html";
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function showSection(sectionId) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));

            // Mostrar a selecionada
            document.getElementById('section-' + sectionId).classList.add('active');
            document.getElementById('nav-' + sectionId).classList.add('active');
        }

        function loadDashboardStats() {
            // Total Cashback, Resgatado e Transa√ß√µes
            db.collection("transacoes").where("status", "==", "concluido")
                .onSnapshot((snapshot) => {
                    let totalDistribuido = 0;
                    let totalResgatado = 0;
                    
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        if (t.tipo === 'resgate') {
                            totalResgatado += t.valor || 0;
                        } else {
                            totalDistribuido += t.valor || 0;
                        }
                    });

                    document.getElementById('stat-total-distribuido').innerText = "R$ " + totalDistribuido.toFixed(2).replace('.', ',');
                    document.getElementById('stat-total-resgatado').innerText = "R$ " + totalResgatado.toFixed(2).replace('.', ',');
                    document.getElementById('stat-total-aberto').innerText = "R$ " + (totalDistribuido - totalResgatado).toFixed(2).replace('.', ',');
                });

            // Total Clientes
            db.collection("usuarios").where("role", "==", "cliente")
                .onSnapshot((snapshot) => {
                    document.getElementById('stat-total-clientes').innerText = snapshot.size;
                });

            // Atividade Recente
            db.collection("transacoes").orderBy("dataFinalizacao", "desc").limit(5)
                .onSnapshot((snapshot) => {
                    const activityDiv = document.getElementById('recent-activity');
                    if (snapshot.empty) {
                        activityDiv.innerHTML = "<p>Nenhuma atividade recente.</p>";
                        return;
                    }

                    activityDiv.innerHTML = "";
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const item = document.createElement('div');
                        item.className = 'transaction-item';
                        item.innerHTML = `
                            <span>${t.status === 'concluido' ? '‚úÖ' : '‚è≥'} Transa√ß√£o ${doc.id.substring(0, 6)}...</span>
                            <span>${t.valor ? 'R$ ' + t.valor.toFixed(2) : '-'}</span>
                        `;
                        activityDiv.appendChild(item);
                    });
                });
        }

        function loadUsersList() {
            db.collection("usuarios").orderBy("nome")
                .onSnapshot((snapshot) => {
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = "";
                    snapshot.forEach(doc => {
                        const u = doc.data();
                        const tr = document.createElement('tr');
                        const isBlocked = u.status === 'bloqueado';
                        tr.style.opacity = isBlocked ? '0.5' : '1';
                        
                        tr.innerHTML = `
                            <td>${u.nome} ${isBlocked ? 'üö´' : ''}</td>
                            <td>${u.email}</td>
                            <td>R$ ${u.saldo.toFixed(2)}</td>
                            <td><span class="role-badge role-${u.role}">${u.role}</span></td>
                            <td style="display: flex; gap: 5px;">
                                <button onclick="toggleUserRole('${doc.id}', '${u.role}')" class="btn-secondary" style="width: auto; padding: 5px 10px; font-size: 0.7rem;">Role</button>
                                <button onclick="toggleUserStatus('${doc.id}', '${u.status || 'ativo'}')" class="${isBlocked ? 'btn-primary' : 'btn-logout'}" style="width: auto; padding: 5px 10px; font-size: 0.7rem; background: ${isBlocked ? '#2ecc71' : '#e74c3c'}">
                                    ${isBlocked ? 'Desbloquear' : 'Bloquear'}
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'bloqueado' ? 'ativo' : 'bloqueado';
            const acao = newStatus === 'bloqueado' ? 'BLOQUEAR' : 'DESBLOQUEAR';
            if (confirm(`Deseja realmente ${acao} este cliente?`)) {
                db.collection("usuarios").doc(userId).update({ status: newStatus })
                    .then(() => alert(`Usu√°rio ${newStatus} com sucesso!`))
                    .catch(err => alert("Erro: " + err));
            }
        }

        function toggleUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'cliente' : 'admin';
            if (confirm(`Deseja alterar a role de ${currentRole} para ${newRole}?`)) {
                db.collection("usuarios").doc(userId).update({ role: newRole })
                    .then(() => alert("Role atualizada!"))
                    .catch(err => alert("Erro: " + err));
            }
        }

        function loadHistoryList(periodo = 'tudo') {
            let query = db.collection("transacoes").orderBy("dataCriacao", "desc");
            
            if (periodo === 'hoje') {
                const hoje = new Date();
                hoje.setHours(0,0,0,0);
                query = query.where("dataCriacao", ">=", hoje);
            } else if (periodo === 'mes') {
                const mes = new Date();
                mes.setDate(1);
                mes.setHours(0,0,0,0);
                query = query.where("dataCriacao", ">=", mes);
            }

            query.limit(50).onSnapshot((snapshot) => {
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = "";
                if (snapshot.empty) {
                    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Nenhuma transa√ß√£o encontrada para este per√≠odo.</td></tr>";
                    return;
                }
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const data = t.dataCriacao ? t.dataCriacao.toDate().toLocaleString('pt-BR') : '...';
                    const valorStr = t.valor ? t.valor.toFixed(2) : '-';
                    const tipo = t.tipo || 'ganho';
                    const cor = tipo === 'resgate' ? 'color: var(--error-color);' : 'color: var(--success-color);';
                    const sinal = tipo === 'resgate' ? '-' : '+';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data}</td>
                        <td>${t.userId.substring(0, 8)}... (${tipo})</td>
                        <td>${t.produtosStr || t.quantidadeProdutos || '-'}</td>
                        <td style="${cor}">${sinal} R$ ${valorStr}</td>
                        <td>${t.status}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function filtrarHistorico(periodo) {
            loadHistoryList(periodo);
        }

        let gradeProdutos = [];
        let produtosSelecionados = new Set();

        function loadProductsList() {
            db.collection("produtos").orderBy("nome")
                .onSnapshot((snapshot) => {
                    gradeProdutos = [];
                    const tableBody = document.getElementById('products-table-body');
                    const selectionList = document.getElementById('products-selection-list');
                    
                    tableBody.innerHTML = "";
                    selectionList.innerHTML = "";

                    if (snapshot.empty) {
                        tableBody.innerHTML = "<tr><td colspan='3'>Nenhum produto cadastrado.</td></tr>";
                        selectionList.innerHTML = "<p>Nenhum produto para selecionar.</p>";
                        return;
                    }

                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const id = doc.id;
                        gradeProdutos.push({ id, ...p });

                        // Adicionar na tabela de gerenciamento
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${p.nome}</td>
                            <td>R$ ${p.valorCashback.toFixed(2)}</td>
                            <td>
                                <button onclick="removerProduto('${id}')" style="width: auto; padding: 5px 10px; background: var(--error-color); color: white;">Remover</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);

                        // Adicionar na lista de sele√ß√£o de lan√ßamento
                        const div = document.createElement('div');
                        div.style = "background: #444; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;";
                        div.id = `select-prod-${id}`;
                        div.onclick = () => toggleSelectProduct(id);
                        div.innerHTML = `
                            <span style="font-size: 0.8rem;">${p.nome}</span>
                            <span style="font-size: 0.7rem; color: var(--primary-color);">R$ ${p.valorCashback.toFixed(2)}</span>
                        `;
                        selectionList.appendChild(div);
                    });
                });
        }

        function toggleSelectProduct(id) {
            const div = document.getElementById(`select-prod-${id}`);
            if (produtosSelecionados.has(id)) {
                produtosSelecionados.delete(id);
                div.style.background = "#444";
                div.style.border = "none";
            } else {
                produtosSelecionados.add(id);
                div.style.background = "#555";
                div.style.border = "1px solid var(--primary-color)";
            }
            atualizarValorCalculado();
        }

        function atualizarValorCalculado() {
            const qtd = parseInt(document.getElementById('qtd-produtos').value) || 1;
            let total = 0;
            produtosSelecionados.forEach(id => {
                const p = gradeProdutos.find(item => item.id === id);
                if (p) total += p.valorCashback;
            });
            const valorFinal = total * qtd;
            document.getElementById('valor-calculado-display').innerText = `Valor Total: R$ ${valorFinal.toFixed(2).replace('.', ',')}`;
        }

        // Listener para quantidade
        document.getElementById('qtd-produtos').oninput = atualizarValorCalculado;

        function adicionarProduto() {
            const nome = document.getElementById('new-product-name').value;
            const valor = parseFloat(document.getElementById('new-product-cashback').value);

            if (!nome || isNaN(valor)) {
                alert("Preencha o nome e o valor corretamente!");
                return;
            }

            db.collection("produtos").add({
                nome: nome,
                valorCashback: valor
            }).then(() => {
                document.getElementById('new-product-name').value = "";
                document.getElementById('new-product-cashback').value = "";
            }).catch(err => alert("Erro: " + err));
        }

        function removerProduto(id) {
            if (confirm("Deseja remover este produto da grade?")) {
                db.collection("produtos").doc(id).delete()
                    .catch(err => alert("Erro: " + err));
            }
        }

        function processarTransacao(modo = 'lancar') {
            const tokenInputId = modo === 'lancar' ? 'transaction-token-lancar' : 'transaction-token-resgate';
            const statusId = modo === 'lancar' ? 'admin-status-lancar' : 'admin-status-resgate';
            
            const token = document.getElementById(tokenInputId).value.trim().toUpperCase();
            const qtd = parseInt(document.getElementById('qtd-produtos').value);
            const status = document.getElementById(statusId);

            if (!token) {
                alert("Escaneie ou digite o c√≥digo do cliente!");
                return;
            }

            status.innerText = "Processando...";

            const transacaoRef = db.collection("transacoes").doc(token);

            db.runTransaction((transaction) => {
                return transaction.get(transacaoRef).then((tDoc) => {
                    if (!tDoc.exists) {
                        throw "C√≥digo inv√°lido!";
                    }

                    const tData = tDoc.data();
                    if (tData.usado) {
                        throw "Este c√≥digo j√° foi utilizado!";
                    }

                    const tipo = tData.tipo || 'ganho';
                    
                    // Valida√ß√£o de seguran√ßa: garantir que o admin est√° na aba certa para o tipo de QR
                    if (modo === 'lancar' && tipo === 'resgate') {
                        throw "Este √© um QR de RESGATE. Use a aba 'Resgatar Saldo'!";
                    }
                    if (modo === 'resgate' && tipo === 'ganho') {
                        throw "Este √© um QR de GANHO. Use a aba 'Dar Cashback'!";
                    }

                    let valorFinal = 0;
                    let produtosStr = "";

                    // Se for ganho, calculamos baseado nos produtos selecionados
                    if (tipo === 'ganho') {
                        if (produtosSelecionados.size === 0) {
                            throw "Selecione ao menos um produto para o cashback!";
                        }

                        let totalPorUnidade = 0;
                        const nomesProdutos = [];
                        produtosSelecionados.forEach(id => {
                            const p = gradeProdutos.find(item => item.id === id);
                            if (p) {
                                totalPorUnidade += p.valorCashback;
                                nomesProdutos.push(p.nome);
                            }
                        });
                        valorFinal = totalPorUnidade * qtd;
                        produtosStr = nomesProdutos.join(", ") + ` (x${qtd})`;
                    } else {
                        // Se for resgate, o valor j√° vem no token
                        valorFinal = tData.valor || 0;
                    }

                    const userRef = db.collection("usuarios").doc(tData.userId);

                    return transaction.get(userRef).then((uDoc) => {
                        if (!uDoc.exists) {
                            throw "Usu√°rio n√£o encontrado!";
                        }

                        const saldoAtual = uDoc.data().saldo || 0;
                        let novoSaldo;

                        if (tipo === 'resgate') {
                            if (saldoAtual < valorFinal) {
                                throw "Saldo insuficiente do cliente para este resgate!";
                            }
                            novoSaldo = saldoAtual - valorFinal;
                        } else {
                            novoSaldo = saldoAtual + valorFinal;
                        }

                        // 1. Atualiza saldo do usu√°rio
                        transaction.update(userRef, { saldo: novoSaldo });

                        // 2. Marca transa√ß√£o como usada e conclu√≠da
                        transaction.update(transacaoRef, {
                            usado: true,
                            status: 'concluido',
                            adminId: auth.currentUser.uid,
                            quantidadeProdutos: tipo === 'ganho' ? qtd : 1,
                            produtosStr: produtosStr,
                            valor: valorFinal,
                            dataFinalizacao: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        return { valor: valorFinal, tipo: tipo };
                    });
                });
            }).then((result) => {
                const acao = result.tipo === 'resgate' ? "utilizados" : "adicionados";
                status.style.color = result.tipo === 'resgate' ? "#e67e22" : "var(--success-color)";
                status.innerText = `Sucesso! R$ ${result.valor.toFixed(2)} ${acao}.`;
                
                document.getElementById(tokenInputId).value = "";
                if (modo === 'lancar') {
                    document.getElementById('qtd-produtos').value = 1;
                    produtosSelecionados.clear();
                    gradeProdutos.forEach(p => {
                        const div = document.getElementById(`select-prod-${p.id}`);
                        if (div) {
                            div.style.background = "#444";
                            div.style.border = "none";
                        }
                    });
                    atualizarValorCalculado();
                }
            }).catch((err) => {
                status.style.color = "var(--error-color)";
                status.innerText = "Erro: " + err;
                console.error(err);
            });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        }

        let html5QrCode = null;

        function startScanner(modo = 'lancar') {
            const containerId = modo === 'lancar' ? 'reader-container-lancar' : 'reader-container-resgate';
            const readerId = modo === 'lancar' ? 'reader-lancar' : 'reader-resgate';
            const btnId = modo === 'lancar' ? 'start-scan-btn-lancar' : 'start-scan-btn-resgate';

            document.getElementById(containerId).style.display = 'block';
            document.getElementById(btnId).style.display = 'none';

            html5QrCode = new Html5Qrcode(readerId);
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                const tokenInputId = modo === 'lancar' ? 'transaction-token-lancar' : 'transaction-token-resgate';
                document.getElementById(tokenInputId).value = decodedText;
                stopScanner(modo);
                // Opcional: processar automaticamente ao escanear
                // processarTransacao(modo);
            }).catch((err) => {
                console.error("Erro ao iniciar scanner", err);
                alert("Erro ao abrir a c√¢mera. Verifique as permiss√µes.");
                stopScanner(modo);
            });
        }

        function stopScanner(modo = 'lancar') {
            const containerId = modo === 'lancar' ? 'reader-container-lancar' : 'reader-container-resgate';
            const btnId = modo === 'lancar' ? 'start-scan-btn-lancar' : 'start-scan-btn-resgate';

            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById(containerId).style.display = 'none';
                    document.getElementById(btnId).style.display = 'block';
                }).catch((err) => console.error("Erro ao parar scanner", err));
            } else {
                document.getElementById(containerId).style.display = 'none';
                document.getElementById(btnId).style.display = 'block';
            }
        }

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then((registration) => {
                    console.log('SW registrado com sucesso!', registration.scope);
                }).catch((err) => {
                    console.log('Erro ao registrar SW:', err);
                });
            });
        }
    </script>
</body>
</html>
